<!DOCTYPE html>
<html>
	<title> start from scratch </title>
	<head>
		<style>
			body {
				margin : 0px;
				margin-top : 0px;
			}
		</style>
	</head>
	<body>
		<input type = "text" list = "countryList" value = "choose a country" style = "position : absolute ; width : 10vw; height : 2vw ; left : 26.5vw;" onchange = "getGithubCountryRepo(this.value)">
	  <script>
		
			//these two variables will help with prediction the country name
			var countryInputBox = document.getElementById("inputBox");
			var countryList = document.createElement("datalist");
			
			var buttonPanel = document.createElement("div");
			var rightButton = document.createElement("button");
			var leftButton = document.createElement("button");

			//photoSet is a panel to set the photo on
			var photoSet;
			var googleStaticMap;
		
			var table;
			var weather;
			var weather2;
			
			//limit the number of flickr's photos at each request to be 5
			var i = -5;
			var max = 0;
						
			//this function help build a text predicter in the input box
			function pullCountryNames() {	
				var countryNamesRequest = new XMLHttpRequest();
				document.body.appendChild(countryList);
				countryList.id = "countryList";
				countryNamesRequest.open("get", 'https://raw.githubusercontent.com/mledoze/countries/master/countries.json', true);
				countryNamesRequest.send();
				countryNamesRequest.onload = function() {
					JSON.parse(this.responseText).forEach(function(countryItem) {
						var option = document.createElement("option");
						countryList.appendChild(option);
						option.value = countryItem.name.common;
					});
				}
			}

			//this is the main function 
			function getGithubCountryRepo(country) {
				var countryRequest = new XMLHttpRequest();
				var countryArea = document.createElement("td");
				var countryRegion = document.createElement("td");
				var countryCapital = document.createElement("td");
				var countryCurrency = document.createElement("td");
				var countryLatitude = document.createElement("td");
				var countryLongitude = document.createElement("td");
				var td1 = document.createElement("td");
			  var td2 = document.createElement("td");
			  var td3 = document.createElement("td");
			  var td4 = document.createElement("td");
			  var td5 = document.createElement("td");
			  var td6 = document.createElement("td");
			  var td7 = document.createElement("td");
			  var td8 = document.createElement("td");
				var countryRow = document.createElement("tr");
				var countryRow2 = document.createElement("tr");
				var countryRow3 = document.createElement("tr");
				var countryRow4 = document.createElement("tr");
				var countryRow5 = document.createElement("tr");
				var countryRow6 = document.createElement("tr");	
				var countryRow7 = document.createElement("tr");
				var countryRow8 = document.createElement("tr");
				var tableHeader = document.createElement("tr");
				var newsHeader = document.createElement("th")
				var tableHeaderData = document.createElement("th");

				//activate rightButton onclick event
				rightButton.onclick = function() {
					if (i === 0) {
						buttonPanel.appendChild(leftButton);
						leftButton.innerText = "back";
						leftButton.style.position = "absolute"
						leftButton.style.left = "50%";
						leftButton.style.width = "50%";
						leftButton.style.height = "2.5vw";
						leftButton.onclick = function() {
							if (i > 0){
								i -= 5;
								max -= 5;
								getFlickrPhotos(commonName, i, max);
							}	
						}
					} else {
						rightButton.innerText = "next";
					}
					if (max <= 100){
						i += 5;
						max += 5;
						getFlickrPhotos(commonName, i, max);
					}
				}
				td = [td1, td2, td3, td4, td5, td6, td7, td8];	
			  weather = document.createElement("td");
				weather2 = document.createElement("td");
				document.body.appendChild(buttonPanel);
				
				//clear the body from all the photos and tables and then add new ones
				if (photoSet) {
					document.body.removeChild(photoSet);
					photoSet = document.createElement("div");
					document.body.appendChild(photoSet);
				}
			
				if (!table){
					table = document.createElement("table");
					googleStaticMap = document.createElement("photo");
				} else {
					document.body.removeChild(table);
					table = document.createElement("table");
					document.body.removeChild(googleStaticMap);
					googleStaticMap = document.createElement("photo");
				}
				

				buttonPanel.appendChild(rightButton);	
				buttonPanel.style.position = "absolute";
				buttonPanel.style.top = "44vw";
				buttonPanel.style.left = "40.5vw";
				buttonPanel.style.width = "19vw";
				rightButton.innerText = "watch photos";
				rightButton.style.position = "absolute";
				rightButton.style.left = "0vw";
				rightButton.style.width = "50%";
				rightButton.style.height = "2.5vw";
				buttonPanel.appendChild(leftButton);
			
				//make a xhr request to a github repo to get information about the desired country
				countryRequest.open("get", 'https://raw.githubusercontent.com/mledoze/countries/master/countries.json', true);
				countryRequest.send();
				countryRequest.onload = function() {
					//build up a table to set the information on
					table = document.createElement("table");
					document.body.appendChild(table);		
					table.appendChild(tableHeader);
					tableHeader.appendChild(tableHeaderData);
					tableHeader.appendChild(newsHeader);
					tableHeader.appendChild(newsHeader);
					tableHeaderData.innerText = "General Information";
					newsHeader.innerText = "NEWS";
					table.appendChild(countryRow);
					table.appendChild(countryRow2);
					table.appendChild(countryRow3);
					table.appendChild(countryRow4);
					table.appendChild(countryRow5);
					table.appendChild(countryRow6);
					table.appendChild(countryRow7);
					table.appendChild(countryRow8);
					countryRow.appendChild(countryArea);
					countryRow2.appendChild(countryRegion);
					countryRow3.appendChild(countryCapital);
					countryRow4.appendChild(countryLatitude);
					countryRow5.appendChild(countryLongitude);
					countryRow6.appendChild(countryCurrency);
					countryRow7.appendChild(weather);
					countryRow8.appendChild(weather2);
					countryRow.appendChild(td1);
					countryRow2.appendChild(td2);
					countryRow3.appendChild(td3);
					countryRow4.appendChild(td4);
					countryRow5.appendChild(td5);
					countryRow6.appendChild(td6);
					countryRow7.appendChild(td7);
					countryRow8.appendChild(td8);
					table.style.position = "absolute";
					table.style.left = "38vw";
					table.style.height = "25vw";
					table.style.width = "60vw";
					table.border = "solid 2px red";
					table.cellSpacing = "15";
					
					for (var j = 0; i < JSON.parse(this.responseText).length; j++) { 
						if (JSON.parse(this.responseText)[j].name.common === country) {
							var currentCountry = JSON.parse(this.responseText)[j];
						  var officialName = currentCountry.name.official;
							commonName = currentCountry.name.common;
							latitude = currentCountry.latlng[0];
							longitude = currentCountry.latlng[1];
							countryCurrency.innerHTML = "Currency = " + currentCountry.currency;
							countryLatitude.innerHTML = "Latitude = " + latitude;
							countryLongitude.innerHTML = "Longitude = " + longitude;
							countryArea.innerHTML = "Area = " + currentCountry.area + " Square Kilometer";
							countryRegion.innerHTML = "Region = " + currentCountry.region;
							countryCapital.innerHTML = "Capital City = " + currentCountry.capital;
							
							//call weather, guardian and googleStaticMap apis
							getWeather(latitude, longitude, weather, weather2);
							pullLatestNews(country);
							drawGoogleMap(latitude, longitude, currentCountry.area);
							break;
						}
					}
				}
			}	
			
			function getWeather(latitude, longitude, weather, weather2) {
				var makeWeatherRequest = new XMLHttpRequest();
				makeWeatherRequest.open("get", 'http://api.openweathermap.org/data/2.5/weather?lat=' + latitude +
				'&lon=' + longitude + '&appid=bd5bc1519755874543545ebe815796ba', true);
				makeWeatherRequest.send();
				makeWeatherRequest.onload = function() {
					weather.innerHTML = "Weather Description = " + JSON.parse(this.responseText).weather[0].description;
					weather2.innerHTML	= "Temprature = " + (JSON.parse(this.responseText).main.temp - 273.15, 2).toFixed() + "  Celsius" ;
				}
			}
			
			function getFlickrPhotos(country, i, max) {	
				var init = -16.5;
					if (!photoSet) {
					photoSet = document.createElement("div");
					document.body.appendChild(photoSet);
				} else {
					document.body.removeChild(photoSet);
					photoSet = document.createElement("div");
					document.body.appendChild(photoSet);
				}
				
				var makeFlickrRequest = new XMLHttpRequest();
				makeFlickrRequest.open("get", 'https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key='+
				'	d25561a9209c49fa69fe6e813cb922fc&tags=' +country + '&extras=url_l&format=json&nojsoncallback=1', true);
				makeFlickrRequest.send();
				makeFlickrRequest.onload = function() {
					for (i = i ; i < max ; i++){
						if (JSON.parse(this.responseText).photos.photo[i]) {
							if (JSON.parse(this.responseText).photos.photo[i].url_l) {
								if(JSON.parse(this.responseText).photos.photo[i]){
									var photoFrame = document.createElement("photo");
									photoSet.appendChild(photoFrame);
									photoFrame.style.position = "relative";
									photoFrame.style.left = init + 19 + "vw";
									var photoUrl = JSON.parse(this.responseText).photos.photo[i].url_l;
									var photo = photoUrl.substr(0,photoUrl.length-5).concat("m").concat(photoUrl.substr(photoUrl.length-4));
									photoFrame.innerHTML = "<img src = 	" + photo + " " + "style = 'border : solid 0px blue ;width : 19vw ; height : 19vw;'" + "/>"
								}	
							}
						}
					}
				}
			}
			

			function drawGoogleMap(latitude, longitude, area) {
				var zoom;
				
				if (area > 5000000){
					zoom = 3;
				} else if (area > 1000000) {
					zoom = 4;
				} else {
					zoom = 6;
				}
				
				document.body.appendChild(googleStaticMap);
				googleStaticMap.innerHTML = "<img src = " + 'https://maps.googleapis.com/maps/api/staticmap?' + 'center=' + latitude + ',' + longitude +'&' +
				'zoom=' + zoom +'&size=600x300&maptype=roadmap&markers=color:green%7Clabel:G%7C' + latitude + ',' + longitude + " " + "style = 'postion : absolute ; top : 0px;width : 25vw ; height : 25vw;'" + '/>';
			}
		

		
		
			//pull latest news from guardian api
			function pullLatestNews(country) {		
				var newsRequest = new XMLHttpRequest();
				newsRequest.open("get", "http://content.guardianapis.com/search?q=" + country + "&from-date=2016-01-01&api-key=f941d0d2-0ab3-419c-b9df-c1107595e92b", true);
				newsRequest.send();
				newsRequest.onload = function() {
					JSON.parse(this.responseText).response.results.forEach(function(item, index) {
						if (index < 8){
						var newsLink = document.createElement("a");
						td[index].appendChild(newsLink);
						newsLink.innerHTML = item.webTitle;
						newsLink.href = item.webUrl;
						}
					});
				}
			}
			
			pullCountryNames();
		
		</script>
	</body>
</html>
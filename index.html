<!DOCTYPE html>
<html>
<title>googleMap and flickr mashup</title>
	<head>
		<style>
		  #body {
			  min-width: 960px
			}
			#mapSpace {
			border : 5px solid green;
			width : 100vw;
			height : 50vh;
			margin-left : 0px;
			margin-right : 0px;
		}
		
		</style>
		
		<script src = "http://maps.googleapis.com/maps/api/js"></script>
		
	</head>
	<body>

	  <div id = "mapSpace"></div>

	<script>
	
		var infoWindow = new google.maps.InfoWindow();
		
		//Call the main function "initialize" when loading the page
		google.maps.event.addDomListener(window, "load", initialize);
		
		//The main function
		function initialize() {
			var center = new google.maps.LatLng(50, 50);
			var mapObject = {
			  center : center,
			  zoom : 3,
			  mapTypeId: google.maps.MapTypeId.ROADMAP
			}
			
		//drawing the map on the "mapSpace"	HTML element
			var map = new google.maps.Map(document.getElementById("mapSpace"), mapObject);
		
		/**
		 *getLatLng function will make a XHR request to a gighub repo
		 *to get the coordinates of every country 
		 *in the world and then draw a marker for each of them
		 */
		getLatLng(map);
		}
	 
		function getLatLng(map) {
			
			var latLngReg = new XMLHttpRequest();
		
			//process the response and drawe a marker for each country using forEach method
			latLngReg.onload = function() {
				JSON.parse(this.responseText).forEach(function(item) {
				
					//drawing markers based on the coordinates get from the JSON object.
					var marker = new google.maps.Marker({
							position : new google.maps.LatLng(item["latlng"][0], item["latlng"][1])
					});
					marker.setMap(map);
				
				/**
				*when clicking on a marker the programs will call makePhotosRequest function with a country name parameter
				*to get all the photos in flicker Api taking at this country.
				*/
					google.maps.event.addListener(marker, "click", function() {
				
				/**
				 *set init variable to -13 to fit the photo's frames on the screen 
				 *and set the zoom to 6 when clicking on a marker
				 */
					map.setZoom(6);
					map.setCenter(marker.position)
					init = -13;
					
				//Adding two buttons at the left and the right of the photo's frames
					var rightButton = document.createElement("button");
					var leftButton = document.createElement("button");
					rightButton.style.width = "5vw";
					rightButton.style.height = "18vw";
					rightButton.style.position = "absolute";
					rightButton.style.left = "95vw";
					document.body.appendChild(rightButton);
					
					/**
					 *making XHR request to weather map api to show the weather information
					 *in an info window above the clicked marker
					 */
					makeWeatherRequest(this.position, map, marker);
					makePhotosRequest(item["name"]["official"], rightButton, leftButton);
					
					// the end of the marker's event handler
				})
				});
			}
		
			//calling a github repo with the coordinates of the countries
			latLngReg.open("get", "https://raw.githubusercontent.com/mledoze/countries/master/countries.json", true);
			latLngReg.send();
		}
		
		//calling flickr api and get the photos 
		function makePhotosRequest(country, rightButton, leftButton) {
			rightButton.innerText = "Welcome to " + country + "!!!!";
			var photoRequest = new XMLHttpRequest();
		
		//process JSON data object response and console log the urls the photos of the requested country
			photoRequest.onload = function() {
			var max = JSON.parse(this.responseText).photos.photo.length;
			var i = -5;
			var maxI = 0;
			rightButton.onclick = function() {
			rightButton.innerText = "forward";
				if (i + 5 >= 0 && ((maxI + 5) / 5) <= parseInt(max / 5) ) {
				i += 5;
				maxI += 5;
				leftButton.innerText = "back";
				leftButton.id = "leftButton"
				leftButton.style.width = "5vw";
				leftButton.style.height = "18vw";
				leftButton.style.position = "absolute";
				document.body.appendChild(leftButton);
				leftButton.onclick = function() {
					i -= 5;
					maxI -= 5;
				if  (i < 5 && i >= 0) {
					document.body.removeChild(document.getElementById("leftButton"));
					show(i, maxI, photoRequest);
				}
				
				if (i < 0) {
					document.body.removeChild(document.getElementById("leftButton"));
					i += 5;
						maxI += 5;  
				}
				
				if (i >= 5){
						show(i, maxI, photoRequest);
				}
				
				}
			 show(i, maxI, photoRequest);
			}
			
			
			}
			}
			
		//send a request to flickr api using a country name as a parameter.
		photoRequest.open("get", " https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=d25561a9209c49fa69fe6e813cb922fc&tags=" + country + "&extras=url_l&format=json&nojsoncallback=1", true);
		photoRequest.send();
		}
		
		// initiate init variable to set the distance between the photos
		var init;
		
		//set the frames next to each other under the map
		function setThePhotos(x, i, maxI) {
		  
			var photoFrame = document.createElement("photo");
		if(x[i].url_l) {
			photoFrame.className = "class";
		document.body.appendChild(photoFrame);

		init += 18;
		
		//setting the frames properties
		photoFrame.style.border = "2px solid yellow"
		photoFrame.style.position = "absolute";
		photoFrame.style.width = "18vw";
		photoFrame.style.height = "18vw";
		
		//set the photos next to each other
		photoFrame.style.left = "" + init + "vw";
		
		//infuse the photos inside the frames
			photoFrame.innerHTML = "<img src = " + '"' + x[i].url_l + '"' + "height = '100%' width = '100%'/>";
		} else {
			console.log("erorr");
			i += 1;
			maxI += 1;
		} 
		}
		
		//show a set of five photos in each call
		function show(i, maxI, photoObject) {
			init = -13;
			var frames = document.getElementsByClassName("class");

				while(frames[0]) {
					document.body.removeChild(frames[0]);
				}
		
				for(i ; i < maxI ; i++){
				setThePhotos(JSON.parse(photoObject.response).photos.photo, i, maxI);
			}
		}
		
		//providing weather information in infoWindows using open weather map api
		function makeWeatherRequest(coordinates, map, marker) {
			var lat = coordinates.lat();
			var lon = coordinates.lng();
			weatherRequest = new XMLHttpRequest() ;
			weatherRequest.open("get", "http://api.openweathermap.org/data/2.5/weather?lat=" + lat + "&lon=" + lon + "&appid=44db6a862fba0b067b1930da0d769e98", true);
			weatherRequest.send();
			weatherRequest.onload = function() {
			
			//setting the content in the info window
				infoWindow.setContent("<p>" + "Weather description is " + JSON.parse(this.responseText).weather[0].description + "</br></br>" + "The tempreature = " + (JSON.parse(this.responseText).main.temp-273.15).toFixed(2) + " Celsius" + "</p>");
			infoWindow.open(map,marker);
			}
		}
		
		</script>
	</body>
</html>